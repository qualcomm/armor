# GitHub Action: Claude Code Review
# Feature: 023-code-review-action
# Purpose: Automated code review using Claude on pull requests

name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: arc-runner-set
    permissions:
      contents: write         # Read repository files and create commits when requested
      pull-requests: write    # Post PR comments
      issues: write           # Comment on issues (@claude mentions)
      id-token: write         # OIDC authentication (Bedrock/Vertex/Foundry)
      actions: read           # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 10    # Non-shallow clone to account for multiple commits for the same PR

      - name: Respond to comments addressing @claude
        uses: qcom-eng-qswat/claude-code-action@v1.0.30
        id: claude
        env:
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_DEFAULT_HAIKU_MODEL: ${{ vars.ANTHROPIC_DEFAULT_HAIKU_MODEL }}
          ANTHROPIC_DEFAULT_SONNET_MODEL: ${{ vars.ANTHROPIC_DEFAULT_SONNET_MODEL }}
          ANTHROPIC_DEFAULT_OPUS_MODEL: ${{ vars.ANTHROPIC_DEFAULT_OPUS_MODEL }}
        with:
          # This is necessary for GitHub MCP server
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Authentication (required)
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # Tool restrictions (security)
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Edit,MultiEdit,Write,Read,Glob,Grep,LS,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(bun:*),Bash(npx:*),Bash(npm:*)"
